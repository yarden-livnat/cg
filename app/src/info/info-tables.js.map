{"version":3,"sources":["info-tables.es6"],"names":[],"mappings":"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","file":"info-tables.js","sourcesContent":["/**\n * Created by yarden on 7/21/15.\n */\n\nimport d3 from 'd3';\nimport postal from 'postal';\n\nimport * as data from '../data';\nimport table from '../components/table';\nimport bar from '../components/bar';\n\nexport default function(opt) {\n  let post = postal.channel('events');\n  let selection;\n  let bars = bar();\n\n  let catFilter = GroupFilter('category');\n  let sysFilter = GroupFilter('system');\n\n  let tagsTable = table('#details-tables', 'tags-table').header([\n    {name: 'name', title: 'Concept', cellAttr: r => r.attr && r.attr.name},\n    {name: 'encounters', render: bars}\n  ]).on('mouseover', function(d) { post.publish('tag.highlight', {name: d.value, show: true}); })\n    .on('mouseout', function(d) { post.publish('tag.highlight', {name: d.value, show: false}); })\n    .on('click', function(d) {\n      if (d3.event.shiftKey) selection.exclude(d.row.tag);\n      else selection.select(d.row.tag);\n    });\n\n  let catTable = table('#details-tables', 'cat-table').header([\n    {name: 'category'},\n    {name: 'n', title: '#tags', attr:'numeric'}\n  ]).on('click', function(d) {\n    catFilter.change(d.value);\n  });\n\n  let sysTable = table('#details-tables', 'sys-table').header([\n    {name: 'system'},\n    {name: 'n', title: '#tags', attr:'numeric'}\n  ]).on('click', function(d) {\n      sysFilter.change(d.value);\n    });\n\n  function init() {\n    postal.subscribe({channel: 'data', topic: 'changed', callback: dataChanged});\n  }\n\n  function dataChanged() {\n    let entry;\n\n    bars.max(d3.max(data.selected, d => d.items.length));\n    tagsTable.data(data.selected.map(tag => {\n      return {\n        name: tag.concept.label,\n        encounters: tag.items.length,\n        tag: tag,\n        attr: {}\n      }\n    }));\n\n    // categories\n    let cat = new Map();\n    for (let tag of data.selected) {\n      let n = cat.get(tag.concept.category) || 0;\n      cat.set(tag.concept.category, n+1);\n    }\n    let categories = [];\n    for (entry of cat.entries()) {\n      categories.push({category: entry[0], n: entry[1]});\n    }\n    catTable.data(categories);\n\n    //systems\n    let sys = new Map();\n    for (let tag of data.selected) {\n      let n = sys.get(tag.concept.system) || 0;\n      sys.set(tag.concept.system, n+1);\n    }\n    let systems = [];\n    for (entry of sys.entries()) {\n      systems.push({system: entry[0], n: entry[1]});\n    }\n    sysTable.data(systems);\n\n    selectionChanged();\n  }\n\n  function selectionChanged() {\n    updateSelectionList();\n\n    let tag, attr = new Map();\n\n    for (tag of selection.selected()) { attr.set(tag.concept.label, 'selected'); }\n    for (tag of selection.excluded()) { attr.set(tag.concept.label, 'excluded'); }\n\n    let rows = tagsTable.data();\n    if (rows) {\n      let max = 0;\n      for(let row of rows) {\n        row.attr.name = attr.get(row.name);\n        //if (attr.get(row.tag.concept.label) != 'excluded') {\n          row.encounters =   selection.countActive(row.tag.items);\n          max = Math.max(max, row.encounters);\n        //} else {\n        //  row.encounters = row.tag.items.length;\n      }\n      bars.max(max);\n      tagsTable.data(rows);\n    }\n\n    let entry;\n    let categories = new Map();\n    let systems = new Map();\n    for (tag of data.selected) {\n      if (selection.countActive(tag.items) > 0) {\n        let c = categories.get(tag.concept.category) || 0;\n        categories.set(tag.concept.category, c+1);\n        let s = systems.get(tag.concept.system) || 0;\n        systems.set(tag.concept.system, s+1);\n      }\n    }\n\n    let cat = [];\n    for (entry of categories.entries()) {\n      cat.push({category: entry[0], n: entry[1]});\n    }\n    catTable.data(cat);\n\n\n    let sys = [];\n    for (entry of systems.entries()) {\n      sys.push({system: entry[0], n: entry[1]});\n    }\n    sysTable.data(sys);\n  }\n\n  function updateSelectionList() {\n    let tag, list = [];\n    for (tag of selection.selected()) {\n      list.push({name: tag.concept.label, attr: 'selected'});\n    }\n    for (tag of selection.excluded()) {\n      list.push({name:  tag.concept.label, attr: 'excluded'});\n    }\n\n    let s = d3.select('#selection-list').selectAll('li')\n      .data(list);\n\n    s.enter().append('li');\n    s.text(d => d.name).attr('class', d => d.attr);\n    s.exit().remove();\n  }\n\n  function GroupFilter(field) {\n    let dispatch = d3.dispatch('change');\n    let group = new Set();\n\n    let f = function(tag) {\n      return group.size == 0 || group.has(tag.concept[field]);\n    };\n\n    f.add = function(item) {\n      group.add(item);\n      dispatch.change();\n    };\n\n    f.remove = function(item) {\n      if (group.delete(item))\n        dispatch.change();\n    };\n\n    f.change = function(item) {\n      if (!group.delete(item))\n        group.add(item);\n      dispatch.change();\n    };\n\n    f.on = function(type, cb) {\n      dispatch.on(type, cb);\n    };\n\n    return f;\n  }\n\n  return {\n    init() {\n      init();\n      return this;\n    },\n\n    selection(s) {\n      selection = s;\n      selection.addTagsFilter(catFilter, 'category', true);\n      selection.addTagsFilter(sysFilter, 'system', true);\n      selection.on('changed.info.tables', selectionChanged);\n      return this;\n    },\n\n    resize() {\n      return this;\n    }\n  };\n}"]}