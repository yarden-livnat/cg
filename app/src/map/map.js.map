{"version":3,"sources":["map.es6"],"names":[],"mappings":"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","file":"map.js","sourcesContent":["/**\n * Created by yarden on 7/3/15.\n */\n\nimport {MAP_DEFAULTS} from 'config';\nimport * as d3 from 'd3';\nimport * as L from 'leaflet';\n\nexport default function (el, opt) {\n\n  const AREA_ALPHA = 0.6;\n  const POPULATION_FACTOR = 1000;\n  const DURATION = 500;\n\n  let colorScale = d3.interpolateLab('#fff', '#f00');\n  let width, height;\n  let population = new Map();\n  let selection;\n  let zipcodes = new Map();\n  let active = new Map();\n  let svg, svgContainer;\n\n  // options = Object.assign({}, MAP_DEFAULTS, opt);\n  let options = MAP_DEFAULTS;\n  let map = new L.Map(el)\n    .addLayer(L.tileLayer(options.mapbox.url, options.mapbox.opt))\n    .setView(options.center, options.zoom);\n\n  let transform = d3.geo.transform({point: projectPoint});\n  let path = d3.geo.path().projection(transform);\n\n  /* Initialize the SVG layer */\n  map._initPathRoot();\n\n  svgContainer = d3.select('#map').select('svg');\n  svg = svgContainer.append('g');\n\n\n  function init() {\n    d3.json(options.zipcodes_file, (error, collection) => {\n      if (error) {\n        // Todo: better error handling\n        console.error(error);\n        return;\n      }\n\n      collection.features.forEach(d => {\n        zipcodes.set(d.properties.Zip_Code, d);\n        //d.LatLng = new L.LatLng(d.geometry.coordinates[1], d.geometry.coordinates[0]);\n      });\n\n      let feature = svg.selectAll(\"path\")\n        .data(collection.features, function(d) { return d.properties.Zip_Code;})\n        .enter().append(\"path\");\n\n      function update() {\n        feature.attr(\"d\", path);\n      }\n\n      map.on('viewreset', update);\n      update();\n    });\n  }\n\n  function projectPoint(x, y) {\n    let point = map.latLngToLayerPoint(new L.LatLng(y, x));\n    this.stream.point(point.x, point.y);\n  }\n\n  function assignColor(zipcode, n) {\n    let f =  n * POPULATION_FACTOR/population.get(zipcode);\n    //console.log('zipcode: '+zipcode+' factor: '+n+'/'+population.get(zipcode)+' -> '+f);\n    if (f > 1) f = 1;\n    return colorScale(f);\n  }\n\n  function selectionChanged() {\n    let current = new Map();\n    selection.domain.forEach(enc => {\n      if (population.has(enc.zipcode)) {\n        let count = current.get(enc.zipcode) || 0;\n        current.set(enc.zipcode, count+1);\n      }\n    });\n\n    console.log(current);\n\n    let update = [];\n    current.forEach((n, zipcode) => {\n      let feature = zipcodes.get(zipcode);\n      if (feature) {\n        feature.alpha = AREA_ALPHA;\n        feature.color = assignColor(zipcode, n);\n        update.push(feature);\n      }\n    });\n    active.forEach((n, zipcode) => {\n      if (!current.has(zipcode)) {\n        let feature = zipcodes.get(zipcode);\n        feature.color = '#fff';\n        feature.alpha = 0;\n        update.push(feature);\n      }\n    });\n\n    let s = svg.selectAll('path')\n      .data(update, function(d) {return d.properties.Zip_Code;})\n      .transition()\n        .duration(DURATION)\n        .style('fill-opacity', function(d) { return d.alpha})\n        .style('fill', function(d) { return d.color})\n        .style('stroke', function(d) { return d.alpha > 0 ? '#333' : '#ccc'; })\n        .style('stroke-width', function(d) { return d.alpha > 0 ? '1px' : 0;});\n\n    active = current;\n  }\n\n  var api = {};\n\n  api.init = function() { init(); };\n\n  api.population = function(map) {\n    population = map;\n    return this;\n  };\n\n  api.selection = function(s) {\n    selection = s;\n    selection.on('changed.map', selectionChanged);\n    return this;\n  };\n\n  api.resize = function(w, h) {\n    width = w;\n    height = h;\n    svgContainer.attr(\"width\", w).attr(\"height\", h);\n    return this;\n  };\n\n  return api;\n}\n"]}