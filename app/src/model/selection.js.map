{"version":3,"sources":["selection.es6"],"names":[],"mappings":"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","file":"selection.js","sourcesContent":["/**\n * Created by yarden on 7/12/15.\n */\n\nimport * as d3 from 'd3'\n\n  function intersect(a, b) {\n    let list = [],\n      ia = 0, ib = 0, // indices\n      na = a.length, nb = b.length,\n      va, vb;\n\n    if (a.length === 0 || b.length === 0) { return list; }\n\n    va = a[0].id;\n    vb = b[0].id;\n    while (true) {\n      if (va < vb) {\n        if (++ia === na) { return list; }\n        va = a[ia].id;\n      } else if (va > vb) {\n        if (++ib === nb) { return list; }\n        vb = b[ib].id;\n      } else { // va == vb\n        list.push(a[ia]);\n        if (++ia === na || ++ib === nb) { return list; }\n        va = a[ia].id;\n        va = b[ib].id;\n      }\n    }\n  }\n\n  function excludeItems(a, b) {\n    let list = [],\n      ia = 0, ib = 0, // indices\n      na = a.length, nb = b.length,\n      va, vb;\n\n    if (a.length === 0 || b.length === 0) { return list; }\n\n    va = a[0].id;\n    vb = b[0].id;\n    while (true) {\n      if (va < vb) {\n        list.push(a[ia]);\n        if (++ia === na) { return list; }\n        va = a[ia].id;\n      } else if (va > vb) {\n        if (++ib === nb) {\n          // accept remaining items in a\n          list.push(a[ia]);\n          while (ia < na) { list.push(a[ia]); ia++; }\n          return list;\n        }\n        vb = b[ib].id;\n      } else { // va == vb\n        // exclude va\n        if (++ia === na) { return list; }\n        if (++ib === nb) {\n          while (ia < na){ list.push(a[ia]); ia++; }\n          return list;\n        }\n        va = a[ia].id;\n        vb = b[ib].id;\n      }\n    }\n  }\n\n  export default function() {\n    let initialDomain = undefined;\n    let filteredDomain = undefined;\n    let domain = [];\n\n    let excluded = new Set();\n    let filters = new Map();\n\n    let tags = new Set();\n\n    let dispatch = d3.dispatch('changed');\n\n    clear(true);\n\n\n    function add(tag) {\n      if (tags.has(tag)) return;\n\n      tags.add(tag);\n      excluded.delete(tag);\n      recompute();\n    }\n\n    function remove(tag) {\n      if (!tags.delete(tag)) return;\n      recompute();\n    }\n\n    function clear(silent) {\n      tags = new Set();\n      excluded = new Set();\n      filteredDomain = initialDomain;\n      domain = initialDomain;\n      if (!silent) {\n        dispatch.changed();\n      }\n    }\n\n    function filterDomain() {\n      domain = initialDomain;\n      filters.forEach(filter => {domain = filter.call(this, domain)});\n      filteredDomain = domain;\n      recompute();\n    }\n\n\n    function recompute() {\n      domain = filteredDomain;\n      tags.forEach(function (tag) {\n        domain = intersect(domain, tag.items);\n      });\n      excluded.forEach(function (tag) {\n        domain = excludeItems(domain, tag.items);\n      });\n\n      dispatch.changed();\n    }\n\n    function check(domain, msg) {\n      for(let i = 0; i < domain.length; i++)\n        if (domain[i] == undefined) console.log(msg, 'at', i);\n    }\n\n    /*\n     * API\n     */\n    let selection = {\n      get domain() { return domain; },\n\n      set domain(list) {\n        initialDomain = list;\n        clear(false);\n      }\n    };\n\n    selection.selectedItems = function() {\n      return tags.size || excluded.size ? domain : [];\n    };\n\n    selection.clear = function(silent) {\n      clear(false);\n    };\n\n    selection.exclude = function (tag, add) {\n      if (add) {\n        if (excluded.has(tag)) return;\n        excluded.add(tag);\n        tags.delete(tag);\n      } else {\n        if (!excluded.delete(tag)) return;\n      }\n      recompute();\n    };\n\n    selection.addFilter = function (filter, key) {\n      filters.set(key, filter);\n      filter.on('change', () => filterDomain());\n      filterDomain();\n    };\n\n    selection.removeFilter = function (key) {\n      let filter = filters.get(key);\n      if (!filter) return;\n      filter.off('change');\n      filters.delete(key);\n      filterDomain();\n    };\n\n    selection.select = function (tag, op) {\n      op = op || op == undefined;\n      if (op) add(tag);\n      else remove(tag)\n    };\n\n    selection.tags = function() {\n      return tags;\n    };\n\n    selection.isAnySelected = function () {\n      return _.some(arguments, function (tag) {\n        if (tags.has(tag)) return true;\n      }, this\n      );\n    };\n\n    selection.on = function(type, listener) {\n      dispatch.on(type, listener);\n      return this;\n    };\n\n    return selection;\n  }\n"]}