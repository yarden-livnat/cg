{"version":3,"sources":["selection.es6"],"names":[],"mappings":"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","file":"selection.js","sourcesContent":["/**\n * Created by yarden on 7/12/15.\n */\n\nimport * as d3 from 'd3'\n\nlet available_colors = d3.scale.category10().range();\nlet default_color = \"gray\";\n\nfunction assign_color(tag) {\n  if (!tag.color) {\n    tag.color = available_colors.shift() || default_color;\n  } else {\n    let i = available_colors.indexOf(tag.color);\n    if (i == -1) {\n      tag.color = available_colors.shift() || default_color;\n    } else {\n      available_colors.splice(i, 1);\n    }\n  }\n}\n\nfunction release_color(tag) {\n  if (tag.color != default_color) {\n    available_colors.push(tag.color);\n  } else {\n    tag.color = undefined;\n  }\n}\n\n  function intersect(a, b) {\n    let list = [],\n      ia = 0, ib = 0, // indices\n      na = a.length, nb = b.length,\n      va, vb;\n\n    if (a.length === 0 || b.length === 0) { return list; }\n\n    va = a[0].id;\n    vb = b[0].id;\n    while (true) {\n      if (va < vb) {\n        if (++ia === na) { return list; }\n        va = a[ia].id;\n      } else if (va > vb) {\n        if (++ib === nb) { return list; }\n        vb = b[ib].id;\n      } else { // va == vb\n        list.push(a[ia]);\n        if (++ia === na || ++ib === nb) { return list; }\n        va = a[ia].id;\n        vb = b[ib].id;\n      }\n    }\n  }\n\n  function excludeItems(a, b) {\n    let list = [],\n      ia = 0, ib = 0, // indices\n      na = a.length, nb = b.length,\n      va, vb;\n\n    if (a.length === 0 || b.length === 0) { return list; }\n\n    va = a[0].id;\n    vb = b[0].id;\n    while (true) {\n      if (va < vb) {\n        list.push(a[ia]);\n        if (++ia === na) { return list; }\n        va = a[ia].id;\n      } else if (va > vb) {\n        if (++ib === nb) {\n          // accept remaining items in a\n          list.push(a[ia]);\n          while (ia < na) { list.push(a[ia]); ia++; }\n          return list;\n        }\n        vb = b[ib].id;\n      } else { // va == vb\n        // exclude va\n        if (++ia === na) { return list; }\n        if (++ib === nb) {\n          while (ia < na){ list.push(a[ia]); ia++; }\n          return list;\n        }\n        va = a[ia].id;\n        vb = b[ib].id;\n      }\n    }\n  }\n\n  export default function() {\n    let initialDomain = undefined;\n    let filteredDomain = undefined;\n    let domain = [];\n\n    let excluded = new Set();\n    let filters = new Map();\n\n    let tags = new Set();\n\n    let dispatch = d3.dispatch('changed');\n\n    clear(true);\n\n\n    function add(tag) {\n      if (tags.has(tag)) return;\n\n      assign_color(tag);\n\n      tags.add(tag);\n      excluded.delete(tag);\n      recompute();\n    }\n\n    function remove(tag) {\n      if (!tags.delete(tag)) return;\n      release_color(tag);\n      recompute();\n    }\n\n    function clear(silent) {\n      for (let tag of tags) {\n        release_color(tag);\n      }\n\n      for (let tag of excluded) {\n        release_color(tag);\n      }\n\n      tags = new Set();\n      excluded = new Set();\n      filteredDomain = initialDomain;\n      domain = initialDomain;\n      if (!silent) {\n        dispatch.changed();\n      }\n    }\n\n    function filterDomain() {\n      domain = initialDomain;\n      filters.forEach(filter => {domain = filter.call(this, domain)});\n      filteredDomain = domain;\n      recompute();\n    }\n\n\n    function recompute() {\n      domain = filteredDomain;\n      tags.forEach(function (tag) {\n        domain = intersect(domain, tag.items);\n      });\n      excluded.forEach(function (tag) {\n        domain = excludeItems(domain, tag.items);\n      });\n\n      dispatch.changed();\n    }\n\n    function check(domain, msg) {\n      for(let i = 0; i < domain.length; i++)\n        if (domain[i] == undefined) console.log(msg, 'at', i);\n    }\n\n    /*\n     * API\n     */\n    let selection = {\n      get domain() { return domain; },\n\n      set domain(list) {\n        initialDomain = list;\n        clear(false);\n      },\n\n      countActive(items) {\n        return intersect(domain, items).length;\n      },\n\n      selectedItems() {\n        return tags.size || excluded.size ? domain : [];\n      },\n\n      clear(silent) {\n        clear(false);\n      },\n\n      exclude(tag, add) {\n        if (add) {\n          if (excluded.has(tag)) return;\n          assign_color(tag);\n          excluded.add(tag);\n          tags.delete(tag);\n        } else {\n          if (!excluded.delete(tag)) return;\n          release_color(tag);\n        }\n        recompute();\n      },\n\n      addFilter(filter, key) {\n        filters.set(key, filter);\n        filter.on('change', () => filterDomain());\n        filterDomain();\n      },\n\n      removeFilter(key) {\n        let filter = filters.get(key);\n        if (!filter) return;\n        filter.off('change');\n        filters.delete(key);\n        filterDomain();\n      },\n\n      select(tag, op) {\n        op = op || op == undefined;\n        if (op) add(tag);\n        else remove(tag)\n      },\n\n      tags() {\n        return tags;\n      },\n\n      excluded() {\n        return excluded;\n      },\n\n      isAnySelected() {\n        return _.some(arguments, function (tag) {\n            if (tags.has(tag)) return true;\n          }, this\n        );\n      },\n\n      on(type, listener) {\n        dispatch.on(type, listener);\n        return this;\n      }\n    };\n\n    return selection;\n  }\n"]}