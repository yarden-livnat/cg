{"version":3,"sources":["cg.es6"],"names":[],"mappings":"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","file":"cg.js","sourcesContent":["/**\n * Created by yarden on 12/17/14.\n */\n\nimport d3 from 'd3'\nimport postal from 'postal';\nimport * as _ from 'lodash'\n\nimport * as data from '../data'\nimport {cg as opt} from '../config'\nimport Graph from './graph'\n\n\nlet ctrl = postal.channel('cg');\n\nexport default function() {\n  let width, height,\n    svgContainer, svg,\n    svgNodes, svgLinks,\n    force = d3.layout.force(),\n    d3nodes, d3links,\n    activeNodes, activeEdges,\n    prevVisible = null,\n    partialLayout = new Set(),\n    selection,\n    graph = Graph();\n\n  let x = d3.scale.linear()\n      .domain([0, 1])\n      .range([0, 1]);\n\n  let y = d3.scale.linear()\n        .domain([0, 1])\n        .range([0, 1]);\n\n  /*\n   * rendering\n   */\n\n    function visibleNodes() {\n      return graph.nodes.filter(function(node) {\n        return node.visible || node.excluded;\n      });\n    }\n\n    function visibleEdges() {\n      if (opt.canvas.showEdges == 'none') return [];\n\n      var all = opt.canvas.showEdges == 'all';\n      var range = opt.canvas.edgeValueSelection;\n      return graph.edges.filter(function (edge) {\n        return edge.source.visible && edge.target.visible\n          && (all || selection.isAnySelected(edge.source.tag, edge.target.tag))\n          && (edge.value >= range[0] && edge.value <= range[1]) ;\n      });\n    }\n\n    function render(duration) {\n      // mark visible nodes\n      graph.nodes.forEach(function(node) {\n          node.visible = node.items.length > 0 || node.excluded;\n          if (node.excluded) {\n            node.scale = node.lastScale;\n          }\n        }\n      );\n\n      activeNodes = visibleNodes();\n      d3nodes = svgNodes.selectAll(\".node\")\n        .data(activeNodes, function (d) { return d.id; });\n\n      d3nodes.enter()\n        .call(Node);\n\n      d3nodes\n        .transition()\n          .duration(duration)\n            .style('opacity', 1)\n            .select('.scaledTag')\n              .call(scaleNode)\n            ;\n\n      d3nodes.exit()\n        .transition()\n        .duration(duration)\n        .style('opacity', 1e-6)\n        .remove();\n\n      // edges\n      d3links = svgLinks.selectAll('.link')\n        .data(visibleEdges(), function (d) { return d.id; });\n\n      d3links.enter()\n        .call(edgeRenderer.render);\n\n      d3links\n        .call(edgeRenderer.update);\n\n      d3links.exit()\n        .transition()\n        .duration(duration)\n        .style('opacity', 1e-6)\n        .remove();\n    }\n\n    /*\n     * Interactions\n     */\n\n    var drag = d3.behavior.drag()\n      .origin(function (d) { return {x: d.x, y: d.y}; })\n      .on('dragstart', onDragStart)\n      .on('drag', onDrag)\n      .on('dragend', onDragEnd);\n\n    var offsetX, offsetY;\n\n    function onDragStart(d, mx, my) {\n      d.fixed |= 2;\n      offsetX = d3.event.sourceEvent.layerX - x(d.x);\n      offsetY = d3.event.sourceEvent.layerY - y(d.y);\n    }\n\n\n    function onDrag(d) {\n      d3.select(this).classed(\"fixed\", d.fixed |= 3);\n      d.x = d.px = x.invert(d3.event.sourceEvent.layerX-offsetX);\n      d.y = d.py = y.invert(d3.event.sourceEvent.layerY-offsetY);\n      d3.select(this).attr('transform', function (d) {\n        return 'translate(' + x(d.x) + ',' + y(d.y) + ')';\n      });\n      d3links.call(edgeRenderer.update);\n    }\n\n    function onDragEnd(d) {\n      d.fixed &= ~6;\n    }\n\n    function dblclick(d) {\n      d3.select(this).classed(\"fixed\", d.fixed = false);\n    }\n\n    var mouse_time = Date.now();\n\n    function mousedown(d) {\n      mouse_time = Date.now();\n      disableZoom();\n    }\n\n    function mouseup(d) {\n      enableZoom();\n\n      var dt = Date.now() - mouse_time;\n      if (dt < 200) {\n        if (d3.event.metaKey)       { d3.select(this).classed(\"fixed\", d.fixed = false); }\n        else if (d3.event.shiftKey) { excludeNode.call(this, d); }\n        else                        { selectNode.call(this, d); }\n      }\n    }\n\n    function mouseover(d) {\n      d3.select(this.parentNode).select('text')\n        .transition()\n        .duration(opt.canvas.duration)\n        .attr('transform', 'translate(7, 0) scale(1)');\n    }\n\n    function mouseout(d) {\n      d3.select(this.parentNode).select('text')\n        .transition()\n        .duration(opt.canvas.duration)\n        .call(scaleNode);\n    }\n\n    /*\n     * Selection\n     */\n    function selectNode(d) {\n      force.stop();\n\n      //d.selected = !d.selected;\n      //d3.select(this).classed('selected', d.selected);\n\n      // TODO: check what the preVisible is all about\n      //if (!d.selected  && partialLayout.delete(d.tag)) {\n      //  prevVisible = _.filter(graph.nodes, function(node) { return node.visible; });\n      //} else {\n      //  prevVisible = null;\n      //}\n      //\n      //if (d.selected && d.excluded) {\n      //  d.excluded = false;\n      //  d3.select(this).classed('excluded', false);\n      //}\n      //d3.select(this).select('.frame')\n      //  .transition()\n      //  .duration(opt.canvas.duration)\n      //  .style('opacity', d.selected ? 1 : 0);\n\n      selection.select(d.tag,  !d.selected);\n    }\n\n    function excludeNode(d) {\n      force.stop();\n\n      //d.excluded = !d.excluded;\n      //d3.select(this).classed('excluded', d.excluded);\n      //\n      //if (d.excluded && d.selected) {\n      //  d.selected = false;\n      //  d3.select(this).classed('selected', false);\n      //}\n      //if (d.excluded) {\n      //  d.lastScale = d.scale;\n      //}\n\n      //d3.select(this).select('.frame')\n      //  .transition()\n      //  .duration(opt.canvas.duration)\n      //  .style('opacity', d.excluded ? 1 : 0);\n\n      selection.exclude(d.tag,  !d.excluded);\n    }\n\n    function selectionChanged() {\n      if (graph == undefined) return;\n      graph.domain = selection.domain;\n\n      let tag, state = new Map();\n      let changed = [];\n\n      for (tag of selection.tags()) { state.set(tag, 'selected'); }\n      for (tag of selection.excluded()) { state.set(tag, 'excluded');}\n\n      prevVisible = null;\n      for (let node of graph.nodes) {\n        let s = state.get(node.tag);\n        if (!s) {\n          if (node.selected || node.excluded) {\n            node.selected = node.excluded = false;\n            changed.push(node);\n          }\n        } if (node.selected != (s == 'selected') || node.excluded != (s == 'excluded')) {\n          if (!node.selected && s == 'selected' && partialLayout.delete(node.tag)) {\n            prevVisible = _.filter(graph.nodes, function(node) { return node.visible; });\n          }\n          node.selected = (s == 'selected');\n          node.excluded = (s == 'excluded');\n          changed.push(node);\n        }\n      }\n\n      svgNodes.selectAll(\".node\").data(changed, function(d) { return d.id;})\n        .classed('selected', d => d.selected)\n        .classed('excluded', d => d.excluded)\n        .select('.frame')\n          .transition()\n          .duration(opt.canvas.duration)\n          .style('opacity', d => (d.selected || d.excluded) ? 1 : 0);\n\n\n      if (prevVisible) {\n        adjustLayout();\n        prevVisible = null;\n      }\n      render(opt.canvas.duration);\n    }\n\n\n    /*\n     * layout\n     */\n\n    var exec_forceDone = false;\n    var clock = (function () {\n      var t = [];\n      var l = [];\n\n      function clock() {}\n\n      clock.start = function() {\n        t = [Date.now()]; l = ['start'];\n      };\n\n      clock.mark = function(label) {\n        t.push(Date.now());\n        l.push(label);\n      };\n\n      clock.print = function() {\n        //for (var i=1; i<t.length; i++) {\n        //  console.log(l[i], ':', t[i]-t[i-1], t[i]-t[0]);\n        //}\n      };\n      return clock;\n    })();\n\n\n    function relayout(iter) {\n      selection.tags().forEach(function(tag) {\n        partialLayout.add(tag); });\n\n      iter = iter || 0;\n\n      activeNodes = graph.nodes.filter(function (node) { return node.visible; });\n      activeEdges = graph.edges;\n\n      if (opt.layout.onlyVisibleEdges) {\n        var edgeStrength = opt.canvas.edgeStrength;\n        activeEdges = activeEdges.filter(function (edge) {\n          return edge.source.visible && edge.target.visible\n            //&& edge.value > edgeStrength\n            ;\n        });\n      }\n\n      exec_forceDone = true;\n      clock.start();\n      force\n        .nodes(activeNodes)\n        .links(activeEdges)\n        .on('tick', null)\n        .on('end', forceDone)\n        .start();\n\n      // reduce visible cloud movements\n      clock.mark('loop');\n      for (var i = 0; i < iter; ++i)\n          force.tick();\n\n      clock.mark('update');\n      force.on('tick', updatePosition);\n      clock.mark('after update');\n    }\n\n    function forceDone() {\n      //console.log('force done ', exec_forceDone);\n      if (!exec_forceDone) return;\n\n      exec_forceDone = false;\n\n      if (opt.layout.nudge) {\n        nudge();\n      }\n      clock.mark('force done');\n      clock.print();\n\n      _.forEach(graph.nodes, function(n) { n.px = x; n.py = y;});\n    }\n\n    function adjustLayout() {\n      console.log('adjust layout');\n      var notFixed = _.filter(prevVisible, function (node) { return !(node.fixed & 1); });\n      _.forEach(notFixed, function(node) { node.fixed |= 1; });\n\n\n      graph.nodes.forEach(function(node) {\n          node.visible = node.items.length > 0 || node.excluded;\n          if (node.excluded) {\n            node.scale = node.lastScale;\n          }\n        }\n      );\n\n      var nodes = _.filter(graph.nodes, function(node) { return node.visible; });\n      var edges = _.filter(graph.edges, function(edge) {\n        return edge.source.visible && edge.target.visible;\n      });\n\n      force\n        .nodes(nodes)\n        .links(edges)\n        .on('tick', null)\n        .on('end', null)\n        .start();\n\n      for (var i=0; i<250; i++) force.tick();\n\n      force.stop();\n\n      _.forEach(notFixed, function(node) { node.fixed &= ~1;});\n      _.forEach(graph.nodes, function(n) { n.px = x; n.py = y;});\n      updatePosition();\n    }\n\n    function clamp(v, min, max) {\n      return  v < min ? min : (v> max ? max : v);\n    }\n\n    function updatePosition() {\n      //nudge_once();\n      //console.log('update pos');\n\n      if (opt.layout.clampToWindow) {\n        _.forEach(activeNodes, function (node) {\n          node.x = clamp(node.x,  0, width - node.w);\n          node.y = clamp(node.y,  0, height - node.h);\n        });\n      }\n\n      // x(), y() to account for zoom\n      d3nodes.attr('transform', function (d) {\n        //if (d.label == 'Cough' && d.tag.positive) console.log('cough: ',x(d.x), y(d.y));\n        return 'translate(' + x(d.x) + ',' + y(d.y) + ')'; });\n      d3links.call(edgeRenderer.update);\n\n      // early termination\n      var max = 0, sum = 0, zero = 0, one=0;\n      _.each(activeNodes, function(node) {\n        var dx = Math.abs(node.x -node.px);\n        var dy = Math.abs(node.y - node.py);\n        var speed = Math.sqrt(dx*dx + dy+dy);\n        max = Math.max(speed,  max);\n        sum += speed;\n        if (speed == 0) zero++;\n        if (speed < 1) one++;\n      });\n\n      //var max = _.reduce(activeNodes,  function(max, node) {\n      //  return Math.max(max,  Math.abs(node.x - node.px));\n      //}, 0);\n\n      //console.log('speed  n:',activeNodes.length,' max:', max,  ' avg:',sum/activeNodes.length, 'zero:', zero,  '<1:', one);\n      if (max < opt.layout.minSpeed) {\n        force.stop();\n      }\n    }\n\n\n    function label(node) {\n      return node.tag.positive ? node.label : node.label+'_N';\n    }\n\n    function intersect(b1, b2) {\n      // note: top and bottom are reversed (y points down)\n      return !(b1.x+b1.w < b2.x || b2.x+b2.w < b1.x || b1.y +b1.h < b2.y || b2.y+b2.h< b1.y);\n    }\n\n    var bboxes;\n    var d_max, d_sum;\n\n    function show(flag) {\n      if (bboxes == undefined) bboxes = activeNodes;\n      var data = [];\n      var n = bboxes.length;\n      if (flag) {\n        while (n--) {\n          var i = n;\n          while (i--) {\n            if (intersect(bboxes[n].bbox, bboxes[i].bbox)) {\n              data.push(bboxes[n]);\n              if (data.indexOf(bboxes[i]) == -1)\n                data.push(bboxes[i]);\n            }\n          }\n        }\n      }\n      var o = svg.selectAll('.check')\n        .data(data,  function(d) {return d.id});\n\n      o.enter()\n        .append('rect')\n        .attr('class', 'check')\n        .attr('width', function(d) { return d.bbox.w; })\n        .attr('height', function(d) { return d.bbox.h});\n\n\n      o.attr('transform', function(d) { return 'translate('+ d.bbox.x + ',' + d.bbox.y + ')';});\n\n      o.exit().remove();\n    }\n\n    function nudge() {\n      computeBboxes();\n      show(opt['control'].overlap);\n      d3.timer(function() {\n        var r = nudge_step();\n        updatePosition();\n        return r;\n      });\n    }\n\n    function nudge_once() {\n      if (opt.layout.nudge) {\n        computeBboxes();\n        nudge_step();\n      }\n    }\n\n    function nudge_step() {\n      bboxes = activeNodes;\n      var n = bboxes.length;\n      var i, c = 0;\n\n      d_max = d_sum = 0;\n      while (n--) {\n        i = n;\n        while (i--) {\n          if (intersect(bboxes[n].bbox, bboxes[i].bbox)) {\n            repel(bboxes[n], bboxes[i]);\n            c++;\n          }\n        }\n      }\n\n      //console.log('found', c, d_max,  d_sum/c);\n\n      var done = c == 0 || d_max < 1;\n      show(!done && opt['control'].overlap);\n\n      return done;\n    }\n\n    function repel(n1, n2) {\n\n      var dx = (n1.bbox.x + n1.bbox.w/2)- (n2.bbox.x + n2.bbox.w/2);\n      var dy = (n1.bbox.y + n1.bbox.h/2)- (n2.bbox.y + n2.bbox.h/2);\n\n      var rx = (n1.bbox.w + n2.bbox.w)/2;\n      var ry = (n1.bbox.h + n2.bbox.h)/2;\n\n      var adx = Math.abs(dx);\n      var ady = Math.abs(dy);\n\n      var s = n1.scale/(n1.scale + n2.scale);\n\n      // X\n      var d= Math.min( 4, Math.max(0.3*(rx - adx), 1));\n      if (dx < 0) d = -d;\n\n      var dsx = d*(1-s);\n      n1.bbox.x += dsx;\n      n1.x = x.invert(n1.bbox.x-n1.bbox.offsetX);\n\n      n2.bbox.x -= d*s;\n      n2.x = x.invert(n2.bbox.x-n2.bbox.offsetX);\n\n      // Y\n      d= Math.min(4, Math.max(0.3*(ry - ady), 1));\n      if (dy < 0) d = -d;\n\n      n1.bbox.y += d*(1-s);\n      n1.y = x.invert(n1.bbox.y-n1.bbox.offsetY);\n\n      n2.bbox.y -= d*s;\n      n2.y = x.invert(n2.bbox.y-n2.bbox.offsetY);\n\n      d_sum += dsx;\n      d_max = Math.max(d_max,  dsx);\n    }\n\n    function find(name) {\n      var pos = true;\n      if (name[0] == '_') {\n        name = name.splice(1);\n        pos = false;\n      }\n      return _.find(bboxes,  function(n) { return n.label == name && n.tag.positive == pos; });\n    }\n\n    /*\n     * node rendering\n     */\n\n    function Node() {\n      var g = this.append('g')\n            .attr('class', 'node')\n            .style('opacity', 0.1)\n            .on('mousedown', mousedown)\n            .on('mouseup', mouseup)\n            .on(\"dblclick\", dblclick)\n        ;\n\n      g.append('circle')\n        .attr('class', 'circle')\n        .attr('r', opt.canvas.nodeRadius)\n        //.on('mouseover', mouseover)\n        //.on('mouseout', mouseout)\n      ;\n\n      var tag = g.append('g')\n        .attr('class', 'tag');\n\n      var scaled = tag.append('g')\n        .attr('class', 'scaledTag');\n\n      var frame = scaled.append('g')\n            .classed('frame', true)\n            .style('opacity', 0)\n            //.attr('visibility', 'hidden')\n        ;\n\n      frame.append('rect')\n        .classed('border', true);\n\n      frame.append('rect')\n        .classed('bg', true);\n\n      scaled.append('text')\n        .attr('class', 'tag')\n        .attr('stroke', function (d) { return d.color; })\n        .attr('fill', function (d) { return d.color; })\n        .attr('dy', '.35em')\n        .attr('text-anchor', 'start')\n        .text(function (d) {return d.label; });\n\n      scaled.each(function(d) {\n        var text = this.childNodes[1]\n        var bbox = text.getBBox();\n\n        d.w = bbox.width;\n        d.h = bbox.height;\n\n        d3.select(this).select('.bg')\n          .attr('width', bbox.width-2)\n          .attr('height', bbox.height-2)\n          .attr('x', bbox.x+1)\n          .attr('y', bbox.y+1);\n\n        d3.select(this).select('.border')\n          .attr('width', bbox.width)\n          .attr('height', bbox.height)\n          .attr('y', bbox.y);\n\n      });\n\n      scaled.call(scaleNode);\n\n      g.attr('transform', function (d) { return 'translate(' + x(d.x) + ',' + y(d.y) + ')'; });\n      g.call(drag);\n\n    }\n\n    function scaleNode(node) {\n      node.attr('transform', function (d) {\n          return 'translate(7, 0) scale(' + opt.canvas.nodeScale(d.scale) + ')';\n        }\n      );\n    }\n\n    function computeBboxes() {\n      d3nodes.each(nodeBBox);\n    }\n\n    var tight = false;\n    function nodeBBox(node) {\n\n      var bbox= (tight? this.childNodes[1] : this).getBBox();\n      // to achieve tight bbox reduce height by 4 on each side\n      node.bbox = {\n        x: x(node.x)+bbox.x,\n        y: y(node.y)+bbox.y,\n        w: bbox.width,\n        h: bbox.height,\n        offsetX: bbox.x,\n        offsetY: bbox.y}\n      ;\n    }\n\n    /*\n     * edge rendering\n     */\n\n    var LineRenderer = {\n      render: function() {\n        this.append('line')\n          .attr('class', 'link')\n          .style('stroke-width', function (d) {\n            return opt.canvas.edgeScale(d.value) + '1px'; })\n          .on('mouseover', highlightEdge)\n          .on('mouseout', unhighlightEdge)\n          .style('opacity', 0)\n          .transition()\n            .duration(opt.canvas.duration)\n            .style('opacity', opt.canvas.edgeOpacity)\n        ;\n      },\n\n      update: function(selection) {\n        this\n          .attr('x1', function(d) { return x(d.source.x); })\n          .attr('y1', function(d) { return y(d.source.y); })\n          .attr('x2', function(d) { return x(d.target.x); })\n          .attr('y2', function(d) { return y(d.target.y); });\n\n        //selection.each(function (d) {\n        //  console.log('u:',d.value);\n        //  var dx = d.target.x - d.source.x;\n        //  var dy = d.target.y - d.source.y;\n        //  var r = Math.sqrt(dx * dx + dy * dy);\n        //  //var a = r> 0 ? opt.canvas.get('arrow.len') / r : 0;\n        //  //var o1 = r > 0 ? opt.canvas.get('arrow.offset') / r : 0;\n        //  var o1 = 0;\n        //  var o2 = o1;\n        //  var edge = d3.select(this);\n        //\n        //  edge\n        //    .attr('x1', d.source.x + dx * o1)\n        //    .attr('y1', d.source.y + dy * o1)\n        //    .attr('x2', d.target.x - dx * o2)\n        //    .attr('y2', d.target.y - dy * o2);\n        //});\n      }\n    };\n\n    var edgeRenderer = LineRenderer;\n\n    function highlightEdge(d) {\n      d3.select(this)\n        .classed('highlight', true)\n        .style('opacity', 1);\n    }\n\n    function unhighlightEdge(d) {\n      d3.select(this)\n        .classed('highlight', false)\n        .style('opacity', opt.canvas.edgeOpacity);\n    }\n\n    function updateForce() {\n      force\n        .charge(opt.layout.charge)\n        .friction(opt.layout.friction)\n        .gravity(opt.layout.gravity)\n        .linkStrength(function (d) {\n          return d.value * opt.layout.linkStrength;\n        })\n        .linkDistance(function (d) {\n          //return opt.layout.distScale(d.value);\n          return 40;\n        })\n      ;\n    }\n\n\n    var zoom;\n\n    function disableZoom() {\n      svg.on('mousedown.zoom', null);\n      svg.on('wheel.zoom', null);\n    }\n    function enableZoom() { svg.call(zoom); }\n\n    function onZoom() {\n      d3nodes.attr('transform', zoomTransform);\n      d3links.call(edgeRenderer.update)\n    }\n\n    function zoomTransform(d) {\n      return 'translate(' + x(d.x) + ',' + y(d.y) + ')';\n    }\n\n  function addListeners() {\n   ctrl.subscribe('relayout', () => relayout());\n   ctrl.subscribe('nudge', () => nudge());\n\n   ctrl.subscribe('redraw', () =>  render(opt.canvas.fastDuration));\n   ctrl.subscribe('overlap', () =>  {\n      computeBboxes();\n      show(opt.control.overlap);\n    });\n\n   ctrl.subscribe('layout', () => {\n      updateForce();\n      relayout();\n      render(opt.canvas.fastDuration);\n    });\n\n    postal.subscribe({channel: 'data', topic: 'changed', callback: () => {\n      force.stop();\n      let nodes = data.tags.map(function(d) {\n        return {\n          id: d.id,\n          label: d.concept.label,\n          tag: d,\n          items: d.items\n        };\n      });\n      graph.update(nodes);\n\n      // random initial pos instead of the default (0,0)\n      _.forEach(graph.nodes, function (node) {\n          if (!node.hasOwnProperty('x')) {\n            node.x = Math.random() * width;\n            node.y = Math.random() * height;\n          }\n        }\n      );\n\n      render(opt.canvas.duration);\n      relayout(opt.layout.initIterations);\n      return this;\n    }});\n  }\n\n  /*\n   * API\n   */\n\n  let cg = {};\n\n  cg.init = function(el) {\n    width = d3.select(el).attr('width');\n    height = d3.select(el).attr('height');\n    svgContainer = d3.select(el)\n      .classed(\"cg\", true)\n      .append(\"svg\");\n    svg = svgContainer.append(\"g\");\n\n    // transparent bg to catch pan/zoom mouse actions\n    svg.append(\"rect\")\n      .attr(\"class\", \"overlay\")\n      .attr(\"width\", width)\n      .attr(\"height\", height);\n\n    svgLinks = svg.append(\"g\").attr(\"class\", \"links\");\n    svgNodes = svg.append(\"g\").attr(\"class\", \"nodes\");\n\n    force\n      .on('tick', updatePosition)\n      .on('end', forceDone);\n\n    addListeners();\n    return this;\n  };\n\n  cg.resize = function(size) {\n    force.stop();\n\n    width = size[0];\n    height = size[1];\n\n    svgContainer.attr(\"width\", width).attr(\"height\", height);\n    force.size([width, height]);\n\n    x.domain([0, width]).range([0, width]);\n\n    y.domain([0, height]).range([0, height]);\n\n    zoom = d3.behavior.zoom().x(x).y(y).scaleExtent([.5, 8]).on(\"zoom\", onZoom);\n    svg.call(zoom);\n\n    svg.select('.overlay')\n      .attr('width', width)\n      .attr('height', height);\n\n    if (graph) {\n      relayout();\n      render(opt.canvas.fastDuration);\n    }\n\n    return this;\n  };\n\n  cg.selection = function(s) {\n    selection = s;\n    selection.on('changed.cg', selectionChanged);\n  };\n\n  return cg;\n}\n"]}