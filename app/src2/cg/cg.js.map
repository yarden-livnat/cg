{"version":3,"sources":["cg.es6"],"names":[],"mappings":";;;;;;;;;;;;;;;;;mBAkBe,YAAW;AACxB,QAAI,KAAK,GAAG,GAAG;QAAE,MAAM,GAAG,GAAG,CAAC;AAC9B,QAAI,SAAS,YAAA,CAAC;AACd,QAAI,QAAQ,GAAG,EAAC,CAAC,EAAE,KAAK,EAAE,CAAC,EAAC,MAAM,EAAC,CAAC;AACpC,QAAI,KAAK,YAAA,CAAC;;AAEV,QAAI,SAAS,YAAA;QAAE,GAAG,YAAA;QAAE,QAAQ,YAAA;QAAE,QAAQ,YAAA;QAAE,OAAO,YAAA,CAAC;AAChD,QAAI,OAAO,YAAA;QAAE,OAAO,YAAA,CAAC;;AAErB,QAAI,CAAC,GAAG,gBAAG,KAAK,CAAC,MAAM,EAAE,CACtB,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CACd,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;;AAEjB,QAAI,CAAC,GAAG,gBAAG,KAAK,CAAC,MAAM,EAAE,CACtB,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CACd,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;;AAEjB,QAAI,YAAY,GAAG,eAnBb,YAAY,GAmBe,CAC9B,MAAM,CAAC,QA5BJ,SAAS,CA4BK,MAAM,CAAC,UAAU,CAAC,CACnC,SAAS,CAAC,QA7BP,SAAS,CA6BQ,MAAM,CAAC,SAAS,CAAC,CAAC;;AAEzC,QAAI,YAAY,GAAG,eAvBC,YAAY,GAuBC,CAC9B,KAAK,CAAC,QAhCH,SAAS,CAgCI,MAAM,CAAC,SAAS,CAAC,CACjC,OAAO,CAAC,QAjCL,SAAS,CAiCM,MAAM,CAAC,WAAW,CAAC,CACrC,QAAQ,CAAC,QAlCN,SAAS,CAkCO,MAAM,CAAC,QAAQ,CAAC,CACnC,CAAC,CAAC,CAAC,CAAC,CACJ,CAAC,CAAC,CAAC,CAAC,CAAC;;AAER,QAAI,KAAK,GAAG,wBAAO,CAAC;;AAEpB,QAAI,IAAI,GAAG,gBAAG,QAAQ,CAAC,IAAI,EAAE,CAC1B,MAAM,CAAC,UAAU,CAAC,EAAE;AAAE,aAAO,EAAC,CAAC,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC,EAAC,CAAC;KAAE,CAAC,CACjD,EAAE,CAAC,WAAW,EAAE,eAAe,CAAC,CAChC,EAAE,CAAC,MAAM,EAAE,UAAU,CAAC,CACtB,EAAE,CAAC,SAAS,EAAE,aAAa,CAAC,CAAC;;AAEhC,QAAI,OAAO,YAAA;QAAE,OAAO,YAAA,CAAC;;AAErB,QAAI,SAAS,GAAG,KAAK,CAAC;AACtB,QAAI,WAAW,GAAG,EAAE,CAAC;AACrB,QAAI,WAAW,GAAG,EAAE,CAAC;;AAErB,QAAI,KAAK,GAAG,gBAAG,MAAM,CAAC,KAAK,EAAE,CAC1B,MAAM,CAAC,QArDJ,SAAS,CAqDK,MAAM,CAAC,MAAM,CAAC,CAC/B,QAAQ,CAAC,QAtDN,SAAS,CAsDO,MAAM,CAAC,QAAQ,CAAC,CACnC,OAAO,CAAC,QAvDL,SAAS,CAuDM,MAAM,CAAC,OAAO,CAAC,CACjC,YAAY,CAAC,UAAU,CAAC,EAAE;AAAE,aAAO,CAAC,CAAC,KAAK,GAAG,QAxD1C,SAAS,CAwD2C,MAAM,CAAC,YAAY,CAAC;KAAE,CAAC,CAC9E,YAAY,CAAC,UAAU,CAAC,EAAE;sDAAmD,OAAO,EAAE,CAAC;KAAC,CAC1F,CACE,EAAE,CAAC,MAAM,EAAE,cAAc,CAAC,CAC1B,EAAE,CAAC,KAAK,EAAE,SAAS,CAAC,CAAC;;;;;;AAOxB,QAAI,UAAU,GAAG,CAAC,GAAG,EAAE,CAAC,CAAC;QACrB,UAAU,GAAG,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC;;AAE1B,QAAI,aAAa,GAAG,2BAAU,CAC3B,KAAK,CAAC,GAAG,CAAC,CAAC,MAAM,CAAC,EAAE,CAAC,CACrB,MAAM,CAAC,UAAU,CAAC,CAClB,EAAE,CAAC,QAAQ,EAAE,UAAA,CAAC,EAAI;AACjB,gBAAU,GAAG,CAAC,CAAC;AACf,YAAM,CAAC,QA3EL,SAAS,CA2EM,MAAM,CAAC,YAAY,CAAC,CAAC;AACtC,yBAAmB,EAAE,CAAC;KACvB,CACF,CAAC;;AAEF,QAAI,aAAa,GAAG,2BAAU,CAC3B,KAAK,CAAC,GAAG,CAAC,CAAC,MAAM,CAAC,EAAE,CAAC,CACrB,MAAM,CAAC,UAAU,CAAC,CAClB,EAAE,CAAC,QAAQ,EAAE,UAAA,CAAC,EAAI;AACjB,gBAAU,GAAG,CAAC,CAAC;AACf,YAAM,CAAC,QArFL,SAAS,CAqFM,MAAM,CAAC,YAAY,CAAC,CAAC;KACvC,CACF,CAAC;;AAGF,aAAS,mBAAmB,GAAG;AAC7B,UAAI,MAAM,GAAG,EAAE,CAAC;;;;;;AAChB,6BAAgB,KAAK,CAAC,KAAK,EAAE,8HAAE;cAAvB,IAAI;;AACV,cAAI,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;SACpD;;;;;;;;;;;;;;;;AACD,mBAAa,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;KAC5B;;AAED,aAAS,mBAAmB,GAAG;AAC7B,UAAI,MAAM,GAAG,EAAE,CAAC;;;;;;AAChB,8BAAgB,KAAK,CAAC,KAAK,EAAE,mIAAE;cAAvB,IAAI;;AACV,cAAI,IAAI,CAAC,MAAM,CAAC,OAAO,IAAI,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;SACzE;;;;;;;;;;;;;;;;AACD,mBAAa,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;KAC5B;;;AAGD,QAAI,KAAK,GAAG,IAAI,GAAG,EAAE,CAAC;;AAEtB,wBAAO,SAAS,CAAC,EAAC,OAAO,EAAE,QAAQ,EAAE,KAAK,EAAE,QAAQ,EAAE,QAAQ,EAAE,MAAM,EAAC,CAAC,CAAC;AACzE,wBAAO,SAAS,CAAC,EAAC,OAAO,EAAE,QAAQ,EAAE,KAAK,EAAE,cAAc,EAAE,QAAQ,EAAE,aAAa,EAAC,CAAC,CAAC;AACtF,wBAAO,SAAS,CAAC,EAAC,OAAO,EAAE,UAAU,EAAE,KAAK,EAAE,SAAS,EAAE,QAAQ,EAAE,eAAe,EAAC,CAAC,CAAC;;AAErF,aAAS,eAAe,CAAC,IAAI,EAAE;AAC7B,UAAI,GAAG,GAAG,IAAI,CAAC;AACf,UAAI,IAAI,EAAE;AACR,WAAG,GAAG,IAAI,GAAG,EAAE,CAAC;;;;;;AAChB,gCAAiB,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC;gBAA3B,KAAK;;AACX,eAAG,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,EAAE,KAAK,CAAC,IAAI,CAAC,CAAC;WAAA;;;;;;;;;;;;;;;OACjC;AACD,WAAK,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AAChB,0BAAO,OAAO,CAAC,EAAC,OAAO,EAAE,QAAQ,EAAE,KAAK,EAAE,QAAQ,EAAC,CAAC,CAAC;KAAG;;;AAG1D,aAAS,eAAe,CAAC,CAAC,EAAE,EAAE,EAAE,EAAE,EAAE;AAClC,OAAC,CAAC,KAAK,IAAI,CAAC,CAAC;AACb,aAAO,GAAG,gBAAG,KAAK,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;AAC/C,aAAO,GAAG,gBAAG,KAAK,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;KAChD;;AAED,aAAS,UAAU,CAAC,CAAC,EAAE;AACrB,UAAI,CAAC,gBAAG,KAAK,CAAC,WAAW,CAAC,OAAO,EAC/B,gBAAG,MAAM,CAAC,IAAI,CAAC,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC,CAAC,KAAK,IAAI,CAAC,CAAC,CAAC;;AAEjD,OAAC,CAAC,CAAC,GAAG,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC,MAAM,CAAC,gBAAG,KAAK,CAAC,WAAW,CAAC,MAAM,GAAG,OAAO,CAAC,CAAC;AAC7D,OAAC,CAAC,CAAC,GAAG,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC,MAAM,CAAC,gBAAG,KAAK,CAAC,WAAW,CAAC,MAAM,GAAG,OAAO,CAAC,CAAC;AAC7D,sBAAG,MAAM,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,WAAW,EAAE,UAAU,CAAC,EAAE;AAC7C,eAAO,YAAY,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG,CAAC;OACnD,CACA,CAAC;AACF,aAAO,CAAC,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC;AAClC,UAAI,gBAAG,KAAK,CAAC,WAAW,CAAC,OAAO,EAC9B,KAAK,CAAC,KAAK,EAAE,CAAC,KAEd,KAAK,CAAC,IAAI,EAAE,CAAC;KAChB;;AAED,aAAS,aAAa,CAAC,CAAC,EAAE;AACxB,OAAC,CAAC,KAAK,IAAI,CAAC,CAAC,CAAC;KACf;;;AAGD,QAAI,IAAI,YAAA,CAAC;;AAET,aAAS,WAAW,GAAG;AACrB,aAAO,CACJ,EAAE,CAAC,gBAAgB,EAAE,IAAI,CAAC,CAC1B,EAAE,CAAC,YAAY,EAAE,IAAI,CAAC,CAAC;KAC3B;;AAED,aAAS,UAAU,GAAG;AAAE,aAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;KAAE;;AAE7C,aAAS,MAAM,GAAG;AAChB,aAAO,CAAC,IAAI,CAAC,WAAW,EAAE,UAAU,CAAC,EAAE;AAAE,eAAO,YAAY,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG,CAAC;OAAE,CAAC,CAAC;AAC/F,aAAO,CAAC,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC;KACnC;;;;;AAKD,aAAS,MAAM,CAAC,QAAQ,EAAE;;;AAGxB,WAAK,CAAC,KAAK,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC,GAAG,CAAC,UAAA,IAAI,EAAI;AAClC,YAAI,KAAK,GAAG,SA7KV,SAAS,CA6KW,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AACpC,YAAI,IAAI,GAAG,KAAK,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;AAC/B,YAAI,CAAC,IAAI,EAAE;AACT,cAAI,GAAG;AACL,cAAE,EAAK,IAAI,CAAC,GAAG;AACf,iBAAK,EAAE,KAAK,CAAC,KAAK;AAClB,iBAAK,EAAE,KAAK;AACZ,aAAC,EAAM,IAAI,CAAC,MAAM,EAAE,GAAG,KAAK;AAC5B,aAAC,EAAM,IAAI,CAAC,MAAM,EAAE,GAAG,MAAM;AAC7B,iBAAK,EAAE,CAAC;WACT,CAAC;AACF,eAAK,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,EAAE,IAAI,CAAC,CAAC;SAC3B;;;AAGD,YAAI,CAAC,KAAK,GAAG,EAAE,CAAC;;;;;;AACjB,gCAAkB,IAAI,CAAC,KAAK,mIAAE;gBAArB,KAAK;;AACZ,gBAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;WAC/B;;;;;;;;;;;;;;;;AACA,YAAI,CAAC,KAAK,CAAC,IAAI,CAAC,UAAC,CAAC,EAAE,CAAC;iBAAK,CAAC,GAAG,CAAC;SAAA,CAAC,CAAC;;AAEjC,YAAI,CAAC,QAAQ,GAAG,eAAa,UAAU,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;;AAEjD,YAAI,IAAI,GAAG,IAAI,CAAC,QAAQ,CAAC;AACzB,YAAI,CAAC,QAAQ,GAAG,eAAa,UAAU,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;AACjD,YAAI,IAAI,CAAC,QAAQ,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC;;AAExD,eAAO,IAAI,CAAC;OACb,CAAC,CAAC,CAAC;;AAEJ,YAAM,CAAC,QA5MH,SAAS,CA4MI,MAAM,CAAC,QAAQ,CAAC,CAAC;AAClC,UAAI,QAAQ,EAAE,MAAM,CAAC,QA7MjB,SAAS,CA6MkB,MAAM,CAAC,cAAc,CAAC,CAAC;AACtD,yBAAmB,EAAE,CAAC;AACtB,yBAAmB,EAAE,CAAC;KACvB;;AAED,aAAS,aAAa,GAAG;;AAEvB,YAAM,CAAC,IAAI,CAAC,CAAC;KACd;;AAED,QAAM,gBAAgB,GAAG,KAAK,CAAC;AAC/B,aAAS,MAAM,CAAC,IAAI,EAAE;AACpB,UAAI,YAAY,GAAG,KAAK,CAAC,KAAK,EAAE,CAAC,MAAM,CAAC,UAAA,IAAI;eAAI,IAAI,CAAC,MAAM,CAAC,OAAO,IAAI,IAAI,CAAC,MAAM,CAAC,OAAO,IAC9C,IAAI,CAAC,KAAK,IAAI,UAAU,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,KAAK,IAAI,UAAU,CAAC,CAAC,CAAC;OAAA,CAAC,CAAC;;AAExG,UAAI,gBAAgB,EAAE;;;;;;AACpB,gCAAgB,WAAW,mIAAE;gBAArB,IAAI;;AACV,gBAAI,CAAC,KAAK,IAAI,CAAC,CAAC,CAAC;WAClB;;;;;;;;;;;;;;;;AACD,aAAK,CACF,KAAK,CAAC,WAAW,CAAC,CAClB,KAAK,CAAC,YAAY,mBAAmB,CACrC,EAAE,CAAC,KAAK,EAAE,OAAO,CAAC,CAClB,KAAK,EAAE,CAAC;OACZ,MACI;AACH,aAAK,CACF,KAAK,CAAC,KAAK,CAAC,KAAK,EAAE,CAAC,CACpB,KAAK,CAAC,YAAY,mBAAmB,CACrC,EAAE,CAAC,KAAK,EAAE,IAAI,CAAC,CACf,KAAK,EAAE,CAAC;OACZ;KACF;;AAED,aAAS,OAAO,GAAG;;;;;;;AAEjB,8BAAiB,WAAW,mIAAE;cAArB,IAAI;;AACX,cAAI,CAAC,KAAK,IAAI,CAAC,CAAC;SACjB;;;;;;;;;;;;;;;;;AAED,WAAK,CACF,KAAK,CAAC,KAAK,CAAC,KAAK,EAAE,CAAC,CACpB,KAAK,CAAC,KAAK,CAAC,KAAK,EAAE,CAAC,CACpB,EAAE,CAAC,KAAK,EAAE,IAAI,CAAC,CACf,KAAK,EAAE,CAAC;;AAEX,WAAK,IAAI,CAAC,GAAC,CAAC,EAAE,CAAC,GAAC,GAAG,EAAE,CAAC,EAAE;AACtB,aAAK,CAAC,IAAI,EAAE,CAAC;OAAA,AACf,KAAK,CAAC,IAAI,EAAE,CAAC;;;;;;;AAEb,8BAAiB,WAAW,mIAAE;cAArB,IAAI;;AACX,cAAI,CAAC,KAAK,IAAI,CAAC,CAAC,CAAC;SAClB;;;;;;;;;;;;;;;KAEF;;AAGD,aAAS,KAAK,CAAC,CAAC,EAAE,GAAG,EAAE,GAAG,EAAE;AAC1B,aAAO,CAAC,GAAG,GAAG,GAAG,GAAG,GAClB,CAAC,GAAG,GAAG,GAAG,GAAG,GACX,CAAC,CAAC;KACP;;AAED,aAAS,cAAc,GAAG;AACxB,UAAI,QA7QA,SAAS,CA6QC,MAAM,CAAC,aAAa,EAAE;;;;;;AAClC,gCAAgB,WAAW,mIAAE;gBAArB,IAAI;;AACV,gBAAI,CAAC,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,CAAC,EAAE,CAAC,EAAE,KAAK,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;AAC1C,gBAAI,CAAC,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,CAAC,EAAE,CAAC,EAAE,MAAM,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;WAC5C;;;;;;;;;;;;;;;OACF;;;AAGD,aAAO,CAAC,IAAI,CAAC,WAAW,EAAE,UAAU,CAAC,EAAE;AAAE,eAAO,YAAY,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG,CAAC;OAAE,CAAC,CAAC;;AAE/F,aAAO,CAAC,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC;;;AAGlC,UAAI,GAAG,GAAG,CAAC;UAAE,GAAG,GAAG,CAAC;UAAE,IAAI,GAAG,CAAC;UAAE,GAAG,GAAG,CAAC,CAAC;;;;;;AACxC,8BAAgB,WAAW,mIAAE;cAArB,IAAI;;AACV,cAAI,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,GAAG,IAAI,CAAC,EAAE,CAAC,CAAC;AACpC,cAAI,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,GAAG,IAAI,CAAC,EAAE,CAAC,CAAC;AACpC,cAAI,KAAK,GAAG,IAAI,CAAC,IAAI,CAAC,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,CAAC,CAAC;AACzC,aAAG,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;AAC3B,aAAG,IAAI,KAAK,CAAC;AACb,cAAI,KAAK,IAAI,CAAC,EAAE,IAAI,EAAE,CAAC;AACvB,cAAI,KAAK,GAAG,CAAC,EAAE,GAAG,EAAE,CAAC;SACtB;;;;;;;;;;;AAAA;;;;;;;;;;;;;;KAWF;;AAED,aAAS,SAAS,GAAG;AACnB,aAAO,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;KAC3B;;AAED,aAAS,MAAM,CAAC,QAAQ,EAAE;AACxB,UAAI,CAAC,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;AACnB,iBAAW,GAAG,EAAE,CAAC;;;;;;AACjB,+BAAgB,KAAK,CAAC,KAAK,EAAE,wIAAE;cAAvB,IAAI;;AACV,cAAI,IAAI,CAAC,QAAQ,EAAE;AACjB,gBAAI,CAAC,OAAO,GAAG,IAAI,CAAC;AACpB,gBAAI,CAAC,KAAK,GAAG,IAAI,CAAC,SAAS,CAAC;WAC7B,MAAM;AACL,gBAAI,CAAC,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,IAClC,IAAI,CAAC,KAAK,IAAI,UAAU,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,KAAK,IAAI,UAAU,CAAC,CAAC,CAAC,CAAC;WAC9D;AACD,cAAI,IAAI,CAAC,OAAO,EAAE,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;SAC1C;;;;;;;;;;;;;;;;AAED,aAAO,GAAG,QAAQ,CAAC,SAAS,CAAC,OAAO,CAAC,CAClC,IAAI,CAAC,WAAW,EAAE,UAAA,CAAC;eAAI,CAAC,CAAC,EAAE;OAAA,CAAC,CAAC;;AAEhC,UAAI,QAAQ,GAAG,YAAY,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC,CAAC;AAC7C,cAAQ,CACL,IAAI,CAAC,WAAW,EAAE,UAAU,CAAC,EAAE;AAAE,eAAO,YAAY,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG,CAAC;OAAE,CAAC,CACtF,IAAI,CAAC,aAAa,CAAC,CAAC;;AAGvB,aAAO,CAAC,MAAM,CAAC,MAAM,CAAC,CACnB,OAAO,CAAC,UAAU,EAAE,UAAA,CAAC;eAAI,CAAC,CAAC,QAAQ;OAAA,CAAC,CACpC,IAAI,CAAC,MAAM,EAAE,UAAA,CAAC;eAAI,CAAC,CAAC,KAAK,CAAC,KAAK;OAAA,CAAC,CAAC;;AAEpC,aAAO,CACJ,UAAU,EAAE,CACZ,QAAQ,CAAC,QAAQ,CAAC,CAClB,KAAK,CAAC,SAAS,EAAE,CAAC,CAAC,CACnB,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC;;AAE7B,aAAO,CAAC,IAAI,EAAE,CACX,UAAU,EAAE,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAC/B,KAAK,CAAC,SAAS,EAAE,QAAI,CAAC,CACtB,MAAM,EAAE,CAAC;;AAGZ,iBAAW,GAAG,SAAS,IAAI,KAAK,CAAC,KAAK,EAAE,CAAC,MAAM,CAAC,UAAA,IAAI;eAAI,IAAI,CAAC,MAAM,CAAC,OAAO,IAAI,IAAI,CAAC,MAAM,CAAC,OAAO,IAC7F,IAAI,CAAC,CAAC,IAAI,UAAU,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,CAAC,IAAI,UAAU,CAAC,CAAC,CAAC;OAAA,CACpD,IACE,EAAE,CAAC;;AAER,aAAO,GAAG,QAAQ,CAAC,SAAS,CAAC,OAAO,CAAC,CAClC,IAAI,CAAC,WAAW,EAAE,UAAA,CAAC;eAAI,CAAC,CAAC,EAAE;OAAA,CAAC,CAAC;;AAEhC,aAAO,CAAC,KAAK,EAAE,CACZ,IAAI,CAAC,YAAY,CAAC,CAAC;;AAEtB,aAAO,CACJ,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC;;AAE7B,aAAO,CAAC,IAAI,EAAE,CACX,UAAU,EAAE,CACZ,QAAQ,CAAC,QAAQ,CAAC,CAClB,KAAK,CAAC,SAAS,EAAE,QAAI,CAAC,CACtB,MAAM,EAAE,CAAC;;AAEZ,sBAAG,MAAM,CAAC,aAAa,CAAC,CAAC,IAAI,CAAC,UAAS,mBAAmB,CAAC,CAAC;AAC5D,sBAAG,MAAM,CAAC,SAAS,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,GAAC,MAAM,GAAC,KAAK,CAAC,KAAK,EAAE,CAAC,MAAM,CAAC,CAAC;AAC1E,sBAAG,MAAM,CAAC,YAAY,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,GAAC,MAAM,GAAC,KAAK,CAAC,KAAK,EAAE,CAAC,MAAM,CAAC,CAAC;;;;KAI9E;;;AAGD,QAAI,UAAU,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;;AAE5B,aAAS,aAAa,CAAC,SAAS,EAAE;AAChC,eAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;;AAErB,eAAS,CAAC,SAAS,CAAC,YAAY,CAAC,CAC9B,EAAE,CAAC,WAAW,EAAE,cAAc,CAAC,CAC/B,EAAE,CAAC,SAAS,EAAE,YAAY,CAAC,CAC3B,EAAE,CAAC,YAAY,EAAE,UAAS,CAAC,EAAE;AAAE,sBAAc,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC;OAAE,CAAC,CAC1D,EAAE,CAAC,YAAY,EAAE,UAAS,CAAC,EAAE;AAAE,sBAAc,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC;OAAE,CAAC,CAAC;;;AAI/D,eAAS,CAAC,SAAS,CAAC,QAAQ,CAAC,CAC1B,EAAE,CAAC,OAAO,EAAE,UAAU,CAAC,EAAE;AACxB,wBAAG,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC,CAAC,KAAK,GAAG,KAAK,CAAC,CAAC;OAC9D,CAAC,CAAC;KAEN;;AAED,aAAS,cAAc,CAAC,CAAC,EAAE;AACzB,gBAAU,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;AACxB,iBAAW,EAAE,CAAC;KACf;;AAED,aAAS,YAAY,CAAC,CAAC,EAAE;AACvB,gBAAU,EAAE,CAAC;;AAEb,UAAI,EAAE,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,UAAU,CAAC;AACjC,UAAI,EAAE,GAAG,GAAG,EAAE;AACZ,aAAK,CAAC,IAAI,EAAE,CAAC;AACb,YAAI,gBAAG,KAAK,CAAC,OAAO,EAAE;AAAE,yBAAa,OAAO,CAAC,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;SAAE,MACrC;AAAE,yBAAa,MAAM,CAAC,CAAC,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;SAAE;OAC3D;KACF;;AAED,aAAS,cAAc,CAAC,CAAC,EAAE,IAAI,EAAE;AAC/B,OAAC,CAAC,SAAS,GAAG,IAAI,CAAC;AACnB,UAAI,IAAI,EAAE;AACR,eAAM,YAAY,CAAC,CAAC,CAAC,CAAC;OACvB,MAAM;AACL,eAAM,aAAa,CAAC,CAAC,CAAC,CAAC;OACxB;AACD,0BAAO,OAAO,CAAC,EAAC,OAAO,EAAE,QAAQ,EAAE,KAAK,EAAE,iBAAiB,EAAE,IAAI,EAAE,EAAC,KAAK,EAAE,CAAC,EAAE,IAAI,EAAE,IAAI,EAAC,EAAC,CAAC,CAAC;KAC7F;;;AAGD,aAAS,KAAK,CAAC,SAAS,EAAE;AACxB,SAAG,GAAG,SAAS,CACZ,MAAM,CAAC,KAAK,CAAC,CACb,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;;AAEvB,UAAI,CAAC,GAAG,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;;AAExB,cAAQ,GAAG,EAAE,CAAC,EAAE,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,MAAM,GAAG,aAAa,CAAC,MAAM,EAAE,GAAE,EAAE,CAAC,EAAE,CAAC,EAAC,KAAK,EAAC,CAAC;AAC3E,aAAO,GAAG,CAAC,CAAC,MAAM,CAAC,MAAM,CAAC,CACvB,IAAI,CAAC,OAAO,EAAE,SAAS,CAAC,CACxB,IAAI,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC,CAAC,CACzB,IAAI,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC,CAAC,CAAC;;;AAG9B,UAAI,EAAE,GAAG,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CACnB,IAAI,CAAC,OAAO,EAAE,aAAa,CAAC,CAAC;;AAEhC,mBAAa,CAAC,EAAE,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,OAAO,EAAE,eAAe,CAAC,CAAC,CAAC;;AAE7D,QAAE,CAAC,MAAM,CAAC,MAAM,CAAC,CACd,IAAI,CAAC,WAAW,EAAE,eAAe,IAAE,aAAa,CAAC,MAAM,EAAE,GAAE,CAAC,CAAA,AAAC,GAAG,GAAG,CAAC,CACpE,IAAI,CAAC,UAAU,CAAC,CAAC;;AAEpB,mBAAa,CAAC,EAAE,CAAC,MAAM,CAAC,GAAG,CAAC,CACzB,IAAI,CAAC,OAAO,EAAE,eAAe,CAAC,CAC9B,IAAI,CAAC,WAAW,EAAE,YAAY,IAAI,aAAa,CAAC,KAAK,EAAE,GAAG,EAAE,CAAA,AAAC,GAAE,KAAK,CAAC,CAAC,CAAC;;AAE1E,QAAE,CAAC,MAAM,CAAC,MAAM,CAAC,CACd,IAAI,CAAC,WAAW,EAAE,YAAY,IAAI,EAAE,GAAG,aAAa,CAAC,KAAK,EAAE,GAAG,EAAE,CAAA,AAAC,GAAE,GAAG,IAAI,aAAa,CAAC,MAAM,EAAE,GAAG,CAAC,CAAA,AAAC,GAAG,GAAG,CAAC,CAC7G,IAAI,CAAC,WAAW,CAAC,CACjB,EAAE,CAAC,OAAO,EAAE,YAAY;AACvB,iBAAS,GAAG,CAAC,SAAS,CAAC;AACvB,wBAAG,MAAM,CAAC,IAAI,CAAC,CAAC,OAAO,CAAC,UAAU,EAAE,SAAS,CAAC,CAAC;AAC/C,cAAM,CAAC,QAxcP,SAAS,CAwcQ,MAAM,CAAC,YAAY,CAAC,CAAC;OACvC,CAAC,CAAC;;;AAGL,cAAQ,GAAG,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;AAChD,cAAQ,GAAG,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;;;AAGhD,UAAI,GAAG,gBAAG,QAAQ,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,GAAE,EAAE,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;AAC7E,aAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;;AAEnB,eAAS,CAAC,MAAM,CAAC,QAAQ,CAAC,CACvB,IAAI,CAAC,IAAI,EAAE,UAAU,CAAC,CACtB,IAAI,CAAC,UAAU,CAAC,CAChB,EAAE,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;;AAEvB,eAAS,CAAC,MAAM,CAAC,QAAQ,CAAC,CACvB,IAAI,CAAC,IAAI,EAAE,aAAa,CAAC,CACzB,EAAE,CAAC,QAAQ,EAAE,YAAW;AACvB,aAAK,CAAC,WAAW,CAAC,gBAAG,MAAM,CAAC,IAAI,CAAC,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC;AACrD,cAAM,CAAC,QA5dP,SAAS,CA4dQ,MAAM,CAAC,YAAY,CAAC,CAAC;AACtC,cAAM,CAAC,QA7dP,SAAS,CA6dQ,MAAM,CAAC,cAAc,CAAC,CAAC;AACxC,2BAAmB,EAAE,CAAC;AACtB,2BAAmB,EAAE,CAAC;OACvB,CAAC,CACD,SAAS,CAAC,SAAS,CAAC,CACpB,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CACtC,KAAK,EAAE,CACL,MAAM,CAAC,QAAQ,CAAC,CAChB,IAAI,CAAC,UAAS,CAAC,EAAE;AAAE,eAAO,CAAC,CAAC;OAAC,CAAC,CAC9B,QAAQ,CAAC,OAAO,EAAE,UAAS,CAAC,EAAE;AAAE,eAAO,CAAC,CAAC;OAAC,CAAC,CAAC;;AAEjD,aAAO,CAAC,CAAC;KACV;;AAED,QAAI,EAAE,GAAG,SAAL,EAAE,CAAY,SAAS,EAAE;AAC3B,WAAK,CAAC,SAAS,CAAC,CAAC;AACjB,aAAO,EAAE,CAAC;KACX,CAAC;;AAEF,MAAE,CAAC,KAAK,GAAG,UAAS,CAAC,EAAE;AACrB,UAAI,CAAC,SAAS,CAAC,MAAM,EAAE,OAAO,KAAK,CAAC;AACpC,WAAK,GAAG,CAAC,CAAC;;AAEV,aAAO,IAAI,CAAC;KACb,CAAC;;AAEF,MAAE,CAAC,MAAM,GAAG,UAAS,IAAI,EAAE;AACzB,UAAI,CAAC,SAAS,CAAC,MAAM,EAAE,OAAO,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;AAC9C,WAAK,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;AAChB,YAAM,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;AACjB,OAAC,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,CAAC;AACvC,OAAC,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC,CAAC;AACzC,SAAG,CAAC,IAAI,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC,IAAI,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;;AAEhD,UAAI,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,MAAM,GAAG,aAAa,CAAC,MAAM,EAAE,GAAE,EAAE,CAAC,CAAC;AACzD,SAAG,CAAC,MAAM,CAAC,cAAc,CAAC,CACvB,IAAI,CAAC,WAAW,EAAE,eAAe,GAAC,CAAC,GAAC,GAAG,CAAC,CAAC;;AAE5C,UAAI,GAAG,gBAAG,QAAQ,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,GAAE,EAAE,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;;AAE5E,aAAO,CACJ,IAAI,CAAC,OAAO,EAAE,KAAK,CAAC,CACpB,IAAI,CAAC,QAAQ,EAAE,CAAC,CAAC,CACjB,IAAI,CAAC,IAAI,CAAC,CAAC;;AAEd,WAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;;AAEjB,aAAO,IAAI,CAAC;KACb,CAAC;;AAGF,WAAO,EAAE,CAAC;GACX","file":"cg.js","sourcesContent":["/**\n * Created by yarden on 8/24/15.\n */\n\nimport d3 from 'd3';\nimport postal from 'postal'\n\nimport * as utils from '../utils';\nimport {cgOptions} from '../config';\nimport {topicsMap} from '../service';\nimport * as tagSelection from '../tag_selection';\nimport * as patients from '../patients';\n\nimport Selector from '../components/selector';\n\nimport Graph from './graph';\nimport {NodeRenderer, EdgeRenderer} from './renderers';\n\nexport default function() {\n  let width = 200, height = 200;\n  let dimension;\n  let drawArea = {w: width, h:height};\n  let group;\n\n  let container, svg, svgLinks, svgNodes, overlay;\n  let d3Nodes, d3Links;\n\n  let x = d3.scale.linear()\n    .domain([0, 1])\n    .range([0, 1]);\n\n  let y = d3.scale.linear()\n    .domain([0, 1])\n    .range([0, 1]);\n\n  let nodeRenderer = NodeRenderer()\n    .radius(cgOptions.canvas.nodeRadius)\n    .scaleFunc(cgOptions.canvas.nodeScale);\n\n  let edgeRenderer = EdgeRenderer()\n    .scale(cgOptions.canvas.edgeScale)\n    .opacity(cgOptions.canvas.edgeOpacity)\n    .duration(cgOptions.canvas.duration)\n    .x(x)\n    .y(y);\n\n  let graph = Graph();\n\n  let drag = d3.behavior.drag()\n    .origin(function (d) { return {x: d.x, y: d.y}; })\n    .on('dragstart', onNodeDragStart)\n    .on('drag', onNodeDrag)\n    .on('dragend', onNodeDragEnd);\n\n  let offsetX, offsetY;\n\n  let showEdges = false;\n  let activeNodes = [];\n  let activeEdges = [];\n\n  let force = d3.layout.force()\n    .charge(cgOptions.layout.charge)\n    .friction(cgOptions.layout.friction)\n    .gravity(cgOptions.layout.gravity)\n    .linkStrength(function (d) { return d.value * cgOptions.layout.linkStrength; })\n    .linkDistance(function (d) { /*return cgOptions.layout.distScale(d.value); */ return 40;}\n  )\n    .on('tick', updatePosition)\n    .on('end', forceDone);\n\n  /*\n   * Nodes and Edge Selectors\n   */\n\n\n  let nodesRange = [0.2, 1],\n      edgesRange = [0.7, 1];\n\n  let nodesSelector = Selector()\n    .width(100).height(50)\n    .select(nodesRange)\n    .on('select', r => {\n      nodesRange = r;\n      render(cgOptions.canvas.fastDuration);\n      updateEdgesSelector();\n    }\n  );\n\n  let edgesSelector = Selector()\n    .width(100).height(50)\n    .select(edgesRange)\n    .on('select', r => {\n      edgesRange = r;\n      render(cgOptions.canvas.fastDuration);\n    }\n  );\n\n\n  function updateNodesSelector() {\n    let values = [];\n    for(let node of graph.nodes()) {\n      if (node.items.length > 0) values.push(node.scale);\n    }\n    nodesSelector.data(values);\n  }\n\n  function updateEdgesSelector() {\n    let active = [];\n    for(let edge of graph.edges()) {\n      if (edge.source.visible && edge.target.visible) active.push(edge.value);\n    }\n    edgesSelector.data(active);\n  }\n\n  // Cache\n  let cache = new Map();\n\n  postal.subscribe({channel: 'global', topic: 'render', callback: update});\n  postal.subscribe({channel: 'global', topic: 'data.changed', callback: onDataChanged});\n  postal.subscribe({channel: 'detector', topic: 'changed', callback: detectorChanged});\n\n  function detectorChanged(prob) {\n    let map = null;\n    if (prob) {\n      map = new Map();\n      for(let entry of prob.top(Infinity))\n        map.set(entry.id, entry.prob);\n    }\n    graph.prob(map);\n    postal.publish({channel: 'global', topic: 'render'});  }\n\n  /* nodes behavior */\n  function onNodeDragStart(d, mx, my) {\n    d.fixed |= 2;\n    offsetX = d3.event.sourceEvent.layerX - x(d.x);\n    offsetY = d3.event.sourceEvent.layerY - y(d.y);\n  }\n\n  function onNodeDrag(d) {\n    if (!d3.event.sourceEvent.metaKey)\n      d3.select(this).classed(\"fixed\", d.fixed |= 3);\n\n    d.x = d.px = x.invert(d3.event.sourceEvent.layerX - offsetX);\n    d.y = d.py = y.invert(d3.event.sourceEvent.layerY - offsetY);\n    d3.select(this).attr('transform', function (d) {\n      return 'translate(' + x(d.x) + ',' + y(d.y) + ')';\n    }\n    );\n    d3Links.call(edgeRenderer.update);\n    if (d3.event.sourceEvent.metaKey)\n      force.start();\n    else\n      force.stop();\n  }\n\n  function onNodeDragEnd(d) {\n    d.fixed &= ~2;\n  }\n\n  /* zoom behavior*/\n  let zoom;\n\n  function disableZoom() {\n    overlay\n      .on('mousedown.zoom', null)\n      .on('wheel.zoom', null);\n  }\n\n  function enableZoom() { overlay.call(zoom); }\n\n  function onZoom() {\n    d3Nodes.attr('transform', function (d) { return 'translate(' + x(d.x) + ',' + y(d.y) + ')'; });\n    d3Links.call(edgeRenderer.update);\n  }\n\n  /*\n   * process new data\n   */\n  function update(doLayout) {\n    //force.stop();\n\n    graph.nodes(group.all().map(item => {\n      let topic = topicsMap.get(item.key);\n      let node = cache.get(topic.id);\n      if (!node) {\n        node = {\n          id:    item.key,\n          label: topic.label,\n          topic: topic,\n          x:     Math.random() * width,\n          y:     Math.random() * height,\n          scale: 1\n        };\n        cache.set(topic.id, node);\n      }\n\n      //node.items = item.value.map(entry => entry.enc_id);\n      node.items = [];\n     for (let entry of item.value) {\n       node.items.push(entry.enc_id);\n     }\n      node.items.sort((a, b) => a - b);\n\n      node.selected = tagSelection.isSelected(node.id);\n\n      let prev = node.excluded;\n      node.excluded = tagSelection.isExcluded(node.id);\n      if (node.excluded && !prev) node.lastScale = node.scale;\n\n      return node;\n    }));\n\n    render(cgOptions.canvas.duration);\n    if (doLayout) layout(cgOptions.layout.initIterations);\n    updateNodesSelector();\n    updateEdgesSelector();\n  }\n\n  function onDataChanged() {\n    //layout(cgOptions.layout.initIterations);\n    update(true);\n  }\n\n  const TWO_STEPS_LAYOUT = false;\n  function layout(iter) {\n    let visibleEdges = graph.edges().filter(edge => edge.source.visible && edge.target.visible\n                                             && edge.value >= edgesRange[0] && edge.value <= edgesRange[1]);\n\n    if (TWO_STEPS_LAYOUT) {\n      for(let node of activeNodes) {\n        node.fixed &= ~4;\n      }\n      force\n        .nodes(activeNodes)\n        .links(visibleEdges /*graph.edges()*/)\n        .on('end', layout2)\n        .start();\n    }\n    else {\n      force\n        .nodes(graph.nodes())\n        .links(visibleEdges /*graph.edges()*/)\n        .on('end', null)\n        .start();\n    }\n  }\n\n  function layout2() {\n    // fix active node positions\n    for (let node of activeNodes) {\n      node.fixed |= 4;\n    }\n    // layout using all nodes\n    force\n      .nodes(graph.nodes())\n      .links(graph.edges())\n      .on('end', null)\n      .start();\n\n    for (let i=0; i<100; i++)\n      force.tick();\n    force.stop();\n\n    for (let node of activeNodes) {\n      node.fixed &= ~4;\n    }\n\n  }\n\n\n  function clamp(v, min, max) {\n    return v < min ? min :\n      v > max ? max :\n        v;\n  }\n\n  function updatePosition() {\n    if (cgOptions.layout.clampToWindow) {\n      for(let node of activeNodes) {\n        node.x = clamp(node.x, 0, width - node.w);\n        node.y = clamp(node.y, 0, height - node.h);\n      }\n    }\n\n    // x(), y() to account for zoom\n    d3Nodes.attr('transform', function (d) { return 'translate(' + x(d.x) + ',' + y(d.y) + ')'; });\n\n    d3Links.call(edgeRenderer.update);\n\n    // early termination\n    var max = 0, sum = 0, zero = 0, one = 0;\n    for(let node of activeNodes) {\n      let dx = Math.abs(node.x - node.px);\n      let dy = Math.abs(node.y - node.py);\n      let speed = Math.sqrt(dx * dx + dy + dy);\n      max = Math.max(speed, max);\n      sum += speed;\n      if (speed == 0) zero++;\n      if (speed < 1) one++;\n    }\n\n    //var max = _.reduce(activeNodes,  function(max, node) {\n    //  return Math.max(max,  Math.abs(node.x - node.px));\n    //}, 0);\n\n    //console.log('speed  n:',activeNodes.length,' max:', max,  ' avg:',sum/activeNodes.length, 'zero:', zero,  '<1:', one);\n    //if (max < cgOptions.layout.minSpeed) {\n    //  console.log('stop force');\n    //  force.stop();\n    //}\n  }\n\n  function forceDone() {\n    console.log('force done');\n  }\n\n  function render(duration) {\n    let t = Date.now();\n    activeNodes = [];\n    for(let node of graph.nodes()) {\n      if (node.excluded) {\n        node.visible = true;\n        node.scale = node.lastScale;\n      } else {\n        node.visible = node.items.length > 0 &&\n          node.scale >= nodesRange[0] && node.scale <= nodesRange[1];\n      }\n      if (node.visible) activeNodes.push(node);\n    }\n\n    d3Nodes = svgNodes.selectAll('.node')\n      .data(activeNodes, d => d.id);\n\n    let newNodes = nodeRenderer(d3Nodes.enter());\n    newNodes\n      .attr('transform', function (d) { return 'translate(' + x(d.x) + ',' + y(d.y) + ')'; })\n      .call(node_behavior);\n\n\n    d3Nodes.select('text')\n      .classed('excluded', d => d.excluded)\n      .attr('fill', d => d.topic.color);\n\n    d3Nodes\n      .transition()\n      .duration(duration)\n      .style('opacity', 1)\n      .call(nodeRenderer.update);\n\n    d3Nodes.exit()\n      .transition().duration(duration)\n      .style('opacity', 1e-6)\n      .remove();\n\n\n    activeEdges = showEdges && graph.edges().filter(edge => edge.source.visible && edge.target.visible\n      && edge.r >= edgesRange[0] && edge.r <= edgesRange[1]\n      )\n      || [];\n\n    d3Links = svgLinks.selectAll('.link')\n      .data(activeEdges, d => d.id);\n\n    d3Links.enter()\n      .call(edgeRenderer);\n\n    d3Links\n      .call(edgeRenderer.update);\n\n    d3Links.exit()\n      .transition()\n      .duration(duration)\n      .style('opacity', 1e-6)\n      .remove();\n\n    d3.select(\"#encounters\").text(patients.numActiveEncounters);\n    d3.select(\"#topics\").text(activeNodes.length+' of '+graph.nodes().length);\n    d3.select(\"#relations\").text(activeEdges.length+' of '+graph.edges().length);\n\n    // performance\n    //console.log('render: ', Date.now() -t, 'msec');\n  }\n\n  /* interactions */\n  var mouse_time = Date.now();\n\n  function node_behavior(selection) {\n    selection.call(drag);\n\n    selection.selectAll('.scaledTag')\n      .on('mousedown', node_mousedown)\n      .on('mouseup', node_mouseup)\n      .on('mouseenter', function(d) { node_highlight(d, true); })\n      .on('mouseleave', function(d) { node_highlight(d, false); });\n      //.on(\"dblclick\", node_dblclick)\n\n\n    selection.selectAll('circle')\n      .on('click', function (d) {\n        d3.select(this.parentNode).classed(\"fixed\", d.fixed = false);\n      });\n\n  }\n\n  function node_mousedown(d) {\n    mouse_time = Date.now();\n    disableZoom();\n  }\n\n  function node_mouseup(d) {\n    enableZoom();\n\n    var dt = Date.now() - mouse_time;\n    if (dt < 200) {\n      force.stop();\n      if (d3.event.metaKey) { tagSelection.exclude(d.topic.id); }\n      else                  { tagSelection.select(d.topic.id); }\n    }\n  }\n\n  function node_highlight(d, show) {\n    d.highlight = show;\n    if (show) {\n      utils.assign_color(d);\n    } else {\n      utils.release_color(d);\n    }\n    postal.publish({channel: 'global', topic: 'highlight.topic', data: {topic: d, show: show}});\n  }\n\n  /* init */\n  function build(selection) {\n    svg = selection\n      .append('svg')\n      .attr('class', 'cg');\n\n    let g = svg.append('g');\n\n    drawArea = { h: Math.max(0, height - edgesSelector.height() -10), w:width};\n    overlay = g.append('rect')\n      .attr('class', 'overlay')\n      .attr('width', drawArea.w)\n      .attr('height', drawArea.h);\n\n    /* selectors */\n    let sg = g.append('g')\n      .attr('class', 'cgSelectors');\n\n    nodesSelector(sg.append('g').attr('class', 'nodesSelector'));\n\n    sg.append('text')\n      .attr('transform', 'translate(20,'+(nodesSelector.height()+ 5) + ')')\n      .text('Findings');\n\n    edgesSelector(sg.append('g')\n      .attr('class', 'edgesSelector')\n      .attr('transform', 'translate(' + (nodesSelector.width() + 10) +',0)'));\n\n    sg.append('text')\n      .attr('transform', 'translate(' + (20 + nodesSelector.width() + 10) +',' + (nodesSelector.height() + 5) + ')')\n      .text('Relations')\n      .on('click', function () {\n        showEdges = !showEdges;\n        d3.select(this).classed('selected', showEdges);\n        render(cgOptions.canvas.fastDuration);\n      });\n\n    /* graph */\n    svgLinks = g.append('g').attr('class', 'links');\n    svgNodes = g.append('g').attr('class', 'nodes');\n\n    /* behavior */\n    zoom = d3.behavior.zoom().x(x).y(y).scaleExtent([.5, 20]).on(\"zoom\", onZoom);\n    overlay.call(zoom);\n\n    selection.append('button')\n      .attr('id', 'relayout')\n      .text('relayout')\n      .on('click', layout);\n\n    selection.append('select')\n      .attr('id', 'edgeMeasure')\n      .on('change', function() {\n        graph.edgeMeasure(d3.select(this).property('value'));\n        render(cgOptions.canvas.fastDuration);\n        layout(cgOptions.layout.initIterations);\n        updateNodesSelector();\n        updateEdgesSelector();\n      })\n      .selectAll('.option')\n      .data(Object.keys(graph.measures.edge))\n      .enter()\n        .append('option')\n        .text(function(d) { return d;})\n        .property('value', function(d) { return d;});\n\n    return g;\n  }\n\n  let cg = function(selection) {\n    build(selection);\n    return cg;\n  };\n\n  cg.group = function(_) {\n    if (!arguments.length) return group;\n    group = _;\n\n    return this;\n  };\n\n  cg.resize = function(size) {\n    if (!arguments.length) return [width, height];\n    width = size[0];\n    height = size[1];\n    x.domain([0, width]).range([0, width]);\n    y.domain([0, height]).range([0, height]);\n    svg.attr('width', width).attr('height', height);\n\n    let h = Math.max(0, height - edgesSelector.height() -10);\n    svg.select('.cgSelectors')\n      .attr('transform', 'translate(10,'+h+')');\n\n    zoom = d3.behavior.zoom().x(x).y(y).scaleExtent([.5, 8]).on(\"zoom\", onZoom);\n\n    overlay\n      .attr('width', width)\n      .attr('height', h)\n      .call(zoom);\n\n    force.size(size);\n\n    return this;\n  };\n\n\n  return cg;\n}"]}