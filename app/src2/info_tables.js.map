{"version":3,"sources":["info_tables.es6"],"names":[],"mappings":"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","file":"info_tables.js","sourcesContent":["/**\n * Created by yarden on 8/21/15.\n */\n\nimport d3 from 'd3';\nimport * as postal from 'postal'\n\nimport * as patients from './patients';\nimport {topics} from './service';\n\nimport table from './components/table';\nimport bar from './components/bar';\n\nlet container = d3.select('#details-tables');\nlet topicsMap = new Map();\n\nlet cat = Table(container)\n    .id('cat-table')\n    .header([\n      {name: 'key', title: 'Category'},\n      {name: 'value', title: '#tags', attr:'numeric'}])\n    .dimension(patients.topics_cat);\n\nlet sys = Table(container)\n    .id('sys-table')\n    .header([\n      {name: 'key', title: 'System'},\n      {name: 'value', title: '#tags', attr:'numeric'}])\n    .dimension(patients.topics_sys);\n\nlet bars = bar();\nlet tags = RelTable(container)\n  .id('tags-table')\n  .header([\n    {name: 'topic', title: 'Topic', cellAttr: r => r.attr && r.attr.name},\n    {name: 'value', title: 'Encounters', render: bars}])\n  .in_dimension(patients.rel_tid)\n  .out_dimension(patients.enc_tags);\n  //.on('mouseover', function(d) { post.publish('tag.highlight', {name: d.value, show: true}); })\n  //.on('mouseout', function(d) { post.publish('tag.highlight', {name: d.value, show: false}); })\n\n\npostal.subscribe({channel: 'global', topic: 'render', callback: render});\n\nexport function init() {\n  for (let topic of topics) topicsMap.set(topic.id, topic.label);\n}\n\nfunction reset() {\n}\n\nfunction render() {\n  cat.render();\n  sys.render();\n  tags.render();\n}\n\nfunction Table(div) {\n  let selected = new Set();\n  let excluded = new Set();\n  let dimension;\n  let dirty = false;\n  let inner = table(div)\n    .on('click',  function click(d) {\n      dirty = true;\n      if (selected.delete(d.value)) {\n        d3.select(this)\n          .classed('selected', false);\n      } else {\n        d3.select(this)\n          .classed('selected', true);\n        selected.add(d.value)\n      }\n      if (selected.size == 0)\n        dimension.filterAll();\n      else\n        dimension.filter( v => selected.has(v) );\n      patients.update(dimension);\n\n      // todo: should this be done in patients.update?\n      postal.publish({channel: 'global', topic: 'render'});\n    });\n\n  function api(selection) {\n    return this;\n  }\n\n  api.id = function(_) {\n    inner.id(_);\n    return this;\n  };\n\n  api.header = function(_) {\n    inner.header(_);\n    return this;\n  };\n\n  api.dimension = function(_) {\n    dimension = _;\n    return this;\n  };\n\n  api.render = function() {\n    if (dirty) { dirty = false; }\n    else {\n      inner.data(dimension.group().top(Infinity));\n    }\n    return this;\n  };\n\n  return api;\n}\n\nfunction RelTable(div) {\n  let selected = new Set();\n  let excluded = new Set();\n  let in_dimension;\n  let out_dimension;\n  let dirty = false;\n  let inner = table(div)\n    .on('click',  function click(d) {\n      dirty = true;\n      let key = d.row.key;\n      if (d3.event.ctrlKey) {\n        if (!excluded.delete(key)) excluded.add(key);\n        selected.delete(key);\n      } else {\n        if (!selected.delete(key)) selected.add(key);\n        excluded.delete(key);\n      }\n\n      d3.select(this)\n          .classed('selected', selected.has(key))\n          .classed('excluded', excluded.has(key));\n\n      if (selected.size == 0 && excluded.size == 0)\n        out_dimension.filterAll();\n      else {\n        out_dimension.filter( filter );\n      }\n      patients.update(out_dimension);\n\n      // todo: should this be done in patients.update?\n      postal.publish({channel: 'global', topic: 'render'});\n    });\n\n  function filter(eid) {\n    let enc = patients.encountersMap.get(eid);\n    for (let s of selected) if (!enc.tags.has(s)) return false;\n    for (let e of excluded) if (enc.tags.has(e)) return false;\n    return true;\n  }\n\n  function api(selection) {\n    return this;\n  }\n\n  api.id = function(_) {\n    inner.id(_);\n    return this;\n  };\n\n  api.header = function(_) {\n    inner.header(_);\n    return this;\n  };\n\n  api.in_dimension = function(_) {\n    in_dimension = _;\n    return this;\n  };\n\n  api.out_dimension = function(_) {\n    out_dimension = _;\n    return this;\n  };\n\n  api.render = function() {\n    if (dirty) { dirty = false; }\n    else {\n      let items = in_dimension.group().top(Infinity);\n      items.forEach( item => item.topic = topicsMap.get(item.key) );\n      inner.data( items );\n    }\n    return this;\n  };\n\n  return api;\n}"]}